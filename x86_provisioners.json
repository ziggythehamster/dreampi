{
  "provisioners": [
    {
      "binary": false,
      "execute_command": "echo '{{user `ssh_password`}}' | {{.Vars}} sudo -E -S '{{.Path}}'",
      "expect_disconnect": true,
      "inline": [
        "apt-get install -y cu dnsmasq dnsutils firmware-adi firmware-linux git iputils-arping libnetfilter-queue-dev minicom mgetty netsed ntp ppp p7zip-full python-miniupnpc python-netifaces python-pip python-serial python-sh resolvconf socat sl-modem-dkms usb-modeswitch usbutils vim wvdial",
        "pip install python-iptables",
        "mkdir -p /usr/local/lib/dreampi",
        "chmod 0755 /usr/local/lib/dreampi",
        "git clone --depth 1 git://git.kernel.org/pub/scm/linux/kernel/git/firmware/linux-firmware.git /usr/local/src/linux-firmware",
        "mkdir -p /lib/firmware/keyspan",
        "cp -Rv /usr/local/src/linux-firmware/keyspan/*.fw /lib/firmware/keyspan",
        "chmod 0755 /lib/firmware/keyspan",
        "chmod 0644 /lib/firmware/keyspan/*.fw"
      ],
      "inline_shebang": "/bin/sh -e",
      "only": [
        "virtualbox",
        "qemu"
      ],
      "skip_clean": false,
      "start_retry_timeout": "{{user `start_retry_timeout`}}",
      "type": "shell"
    },
    {
      "type": "file",
      "source": "dreampi.py",
      "destination": "/tmp/dreampi.py",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "dcnow.py",
      "destination": "/tmp/dcnow.py",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "dial-tone.wav",
      "destination": "/tmp/dial-tone.wav",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "config_server.py",
      "destination": "/tmp/config_server.py",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "dte_baud_rate_detector.py",
      "destination": "/tmp/dte_baud_rate_detector.py",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "port_forwarding.py",
      "destination": "/tmp/port_forwarding.py",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "etc/dnsmasq.conf",
      "destination": "/tmp/dnsmasq.conf",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "etc/init.d/dreampi",
      "destination": "/tmp/dreampi",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "vendor/dcgamespy/x86/dcgamespy_1.0.zip",
      "destination": "/tmp/dcgamespy.zip",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "type": "file",
      "source": "vendor/dcvoip/x86/dcvoip_1.0.zip",
      "destination": "/tmp/dcvoip.zip",
      "only": [
        "virtualbox",
        "qemu"
      ]
    },
    {
      "binary": false,
      "execute_command": "echo '{{user `ssh_password`}}' | {{.Vars}} sudo -E -S '{{.Path}}'",
      "expect_disconnect": true,
      "inline": [
        "mkdir /tmp/dcgamespy /tmp/dcvoip",
        "7z x /tmp/dcgamespy.zip -o/tmp/dcgamespy",
        "7z x /tmp/dcvoip.zip -o/tmp/dcvoip",
        "install -v -o root -g root -m 0755 -d /usr/share/doc/dcgamespy /usr/share/doc/dcvoip",
        "install -v -o root -g root -m 0644 /tmp/dcgamespy/x86/usr/share/doc/dcgamespy/copyright /usr/share/doc/dcgamespy/copyright",
        "install -v -o root -g root -m 0755 /tmp/dcgamespy/x86/etc/init.d/dcgamespy /etc/init.d/dcgamespy",
        "install -v -o root -g root -m 0755 /tmp/dcgamespy/x86/usr/bin/dcgamespy /usr/bin/dcgamespy",
        "install -v -o root -g root -m 0644 /tmp/dcvoip/x86/usr/share/doc/dcvoip/copyright /usr/share/doc/dcvoip/copyright",
        "install -v -o root -g root -m 0755 /tmp/dcvoip/x86/etc/init.d/dcvoip /etc/init.d/dcvoip",
        "install -v -o root -g root -m 0755 /tmp/dcvoip/x86/usr/bin/dcvoip /usr/bin/dcvoip",
        "install -v -o root -g root -m 0755 /tmp/config_server.py /usr/local/lib/dreampi/config_server.py",
        "install -v -o root -g root -m 0755 /tmp/dcnow.py /usr/local/lib/dreampi/dcnow.py",
        "install -v -o root -g root -m 0644 /tmp/dial-tone.wav /usr/local/lib/dreampi/dial-tone.wav",
        "install -v -o root -g root -m 0755 /tmp/dreampi.py /usr/local/lib/dreampi/dreampi.py",
        "install -v -o root -g root -m 0755 /tmp/dte_baud_rate_detector.py /usr/local/lib/dreampi/dte_baud_rate_detector.py",
        "install -v -o root -g root -m 0755 /tmp/port_forwarding.py /usr/local/lib/dreampi/port_forwarding.py",
        "install -v -o root -g root -m 0755 /tmp/dreampi /etc/init.d/dreampi",
        "install -v -o root -g root -m 0644 /tmp/dnsmasq.conf /etc/dnsmasq.conf",
        "rm -rv /tmp/dial-tone.wav /tmp/dreampi.py /tmp/dcnow.py /tmp/config_server.py /tmp/dreampi /tmp/dnsmasq.conf /tmp/dte_baud_rate_detector.py /tmp/port_forwarding.py",
        "rm -rfv /tmp/dcgamespy /tmp/dcvoip",
        "ln -s /usr/local/lib/dreampi/dreampi.py /usr/local/bin/dreampi",
        "update-rc.d dreampi defaults",
        "update-rc.d dcgamespy defaults",
        "update-rc.d dcvoip defaults"
      ],
      "inline_shebang": "/bin/sh -e",
      "only": [
        "virtualbox",
        "qemu"
      ],
      "skip_clean": false,
      "start_retry_timeout": "{{user `start_retry_timeout`}}",
      "type": "shell"
    }
  ]
}
